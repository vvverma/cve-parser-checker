#! /bin/bash
# Script to generate downlaod NVD-CVE database

CACHE_DBS=dbs
year=`date +"%Y"`
NIST_URL=https://nvd.nist.gov/feeds/json/cve/1.0 #https://nvd.nist.gov/download

#download nvd-cve files
download_files(){
 resp_code=$( wget -N --server-response  "$NIST_URL/nvdcve-1.0-$1.json.gz" 2>&1 | grep "HTTP/" | awk '{print $2}' )

 if [ $? -ne 0 ]; then
		echo " [ Download Failed nvdcve-1.0-$1.json.gz ]"
		if [ -f "$CACHE_DBS/nvdcve-$1.json" ]; then
			 echo " [ Download Failed: File does exists in Cache nvdcve-$1.json: continue... ]"
		   return
		else
			 echo " [ Download Failed: File does not exists in Cache nvdcve-$1.json: exiting... ]"
			 exit 1
		fi
 fi

 if [ "$resp_code" = "304"   ];then
     rm  ./nvdcve-1.0-$1.modified 2>/dev/null
 else
     touch  ./nvdcve-1.0-$1.modified
 fi


 gunzip --quiet --keep --force  nvdcve-1.0-$1.json.gz
}

echo "Caching NVD-CVE Database Files [ Started ]"
echo -n "[ "
#check if dir exist
	if [ ! -d $CACHE_DBS ] ; then
		mkdir -p $CACHE_DBS
  fi

	cd $CACHE_DBS
  for i in $(seq -f "%04g" 2002 $year); do
			download_files $i
			echo -n "#"
	done
	echo " ] [ Done ]"

echo "Finished NVD-CVE Database [ Done ]"

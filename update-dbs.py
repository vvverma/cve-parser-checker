import requests
import datetime

from dateutil.parser import parse as parsedate
import glob
import os
import pytz
import wget
#for filename in glob.glob('./dbs/*.json.gz'):

if not os.path.exists("./dbs"):
    os.mkdir("dbs")

os.chdir("./dbs")

#today = datetime.today()
year = datetime.datetime.now().year
start_year = 2002

while start_year <= year:
    filename = "nvdcve-1.0-"+str(start_year)+".json.gz"
    url = "https://nvd.nist.gov/feeds/json/cve/1.0/"
    d_url = url+filename
    download = True
    if os.path.exists(filename):
        r = requests.head(d_url)
        url_time = r.headers['Last-Modified']
        print url_time
        url_date = parsedate(url_time, ignoretz=True)
        print url_date
        file_time = datetime.datetime.fromtimestamp(os.path.getmtime("./dbs/nvdcve-1.0-2015.json.gz"))
        print file_time
        if not url_date > file_time :
            download = False
    if download:
        print "downloading"
        print d_url
        r = requests.get(d_url)
        if r.status_code == 200:
            print ("file downloaded %s"%filename)
            file_name = wget.download(d_url)
        else:
            print r.status_code
    start_year = start_year+1
